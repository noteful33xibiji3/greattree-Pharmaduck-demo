<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharma.Duck ç³»çµ±ç®¡ç†å¾Œå°</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #111827; color: white; margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; }
        
        /* é ‚éƒ¨å°èˆª */
        .navbar { background: #1f2937; padding: 15px 30px; border-bottom: 2px solid #F39800; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        h1 { margin: 0; font-size: 20px; color: #F39800; display: flex; align-items: center; gap: 10px; }
        
        /* ä¸»ç‰ˆé¢é…ç½® (å·¦å³åˆ†å‰²) */
        .main-layout { display: flex; flex: 1; overflow: hidden; }
        
        /* å·¦å´ï¼šç·¨è¼¯å€ */
        .editor-panel { flex: 1; padding: 20px; overflow-y: auto; border-right: 1px solid #374151; display: flex; flex-direction: column; gap: 20px; }
        
        /* å³å´ï¼šé è¦½å€ */
        .preview-panel { width: 400px; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; border-left: 5px solid #F39800; background-image: radial-gradient(#333 1px, transparent 1px); background-size: 20px 20px; }
        
        /* æ‰‹æ©Ÿæ¨¡æ“¬å™¨å¤–æ¡† */
        .phone-mockup {
            width: 360px; height: 720px; background: white; border-radius: 30px; 
            border: 8px solid #333; overflow: hidden; position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .phone-mockup iframe { width: 100%; height: 100%; border: none; }
        
        /* è¡¨æ ¼æ¨£å¼ */
        table { width: 100%; border-collapse: collapse; background: #1f2937; border-radius: 8px; overflow: hidden; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #374151; font-size: 14px; }
        th { background: #374151; color: #F39800; }
        tr:hover { background: #2d3748; }
        
        /* è¼¸å…¥æ¡†æ¨£å¼ */
        input[type="text"], input[type="number"] { 
            background: #111827; border: 1px solid #4b5563; color: white; 
            padding: 6px; border-radius: 4px; width: 100%; box-sizing: border-box; 
        }
        input:focus { border-color: #F39800; outline: none; }
        
        /* æ¨¡æ“¬å™¨æ§åˆ¶å€å¡Š */
        .simulation-box {
            background: #374151; padding: 20px; border-radius: 10px; border: 1px solid #4b5563;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .sim-title { margin: 0 0 15px 0; color: #10b981; font-size: 18px; border-bottom: 1px solid #4b5563; padding-bottom: 10px; display: flex; align-items: center; gap: 8px;}
        
        .control-group { margin-bottom: 15px; }
        .control-group label { display: block; margin-bottom: 5px; font-size: 14px; color: #d1d5db; }
        .range-wrapper { display: flex; align-items: center; gap: 10px; }
        input[type="range"] { flex: 1; cursor: pointer; }
        .range-val { width: 100px !important; text-align: center; color: #F39800; font-weight: bold; }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn { border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold; transition: 0.2s; }
        .btn-save { background: #009944; color: white; width: 100%; padding: 12px; font-size: 16px; border-radius: 8px; margin-top: 10px; }
        .btn-apply { background: #3b82f6; color: white; width: 100%; padding: 12px; font-size: 16px; border-radius: 8px; }
        .btn-apply:hover { background: #2563eb; transform: translateY(-2px); }
        .btn-clear { background: #8b5cf6; color: white; width: 100%; padding: 10px; font-size: 14px; border-radius: 8px; margin-top: 10px; }
        .btn-clear:hover { background: #7c3aed; }
        .btn-reset { background: #ef4444; color: white; }

        .preview-img { width: 30px; height: 30px; object-fit: contain; }
    </style>
</head>
<body>

<div class="navbar">
    <h1>ğŸ¦† å¾Œå°ç®¡ç†ç³»çµ±</h1>
    <button class="btn btn-reset" onclick="resetToDefault()">â†º æ¢å¾©åŸå» è¨­å®š</button>
</div>

<div class="main-layout">
    
    <div class="editor-panel">
        
        <div class="simulation-box">
            <h3 class="sim-title">ğŸ•µï¸â€â™‚ï¸ ç©å®¶ç‹€æ…‹æ¨¡æ“¬å™¨</h3>
            
            <div class="control-group">
                <label>ç¶“é©—å€¼ (EXP) - æ‹‰å‹•é è¦½å‡ç´šæ•ˆæœ</label>
                <div class="range-wrapper">
                    <span style="font-size:12px;">0</span>
                    <input type="range" id="simExpSlider" min="0" max="1000000" step="100" value="0" oninput="syncExpInput(this.value)">
                    <span style="font-size:12px;">1M</span>
                    <input type="number" id="simExpInput" class="range-val" value="0" onchange="syncExpSlider(this.value)">
                </div>
            </div>

            <div class="control-group">
                <label>å¤§æ¨¹å¹£ (Coins) - æ¸¬è©¦å•†åŸè³¼è²·</label>
                <div class="range-wrapper">
                    <input type="range" id="simCoinSlider" min="0" max="10000" step="10" value="50" oninput="syncCoinInput(this.value)">
                    <input type="number" id="simCoinInput" class="range-val" value="50" onchange="syncCoinSlider(this.value)">
                </div>
            </div>

            <button class="btn btn-apply" onclick="applySimulation()">ğŸš€ å¥—ç”¨æ•¸å€¼ä¸¦åˆ·æ–°é è¦½</button>
            
            <button class="btn btn-clear" onclick="clearShopPurchases()">ğŸ›’ æ¸…é™¤å•†åŸè³¼è²·ç´€éŒ„ (é‡ç½®è¡£æ«ƒ)</button>
        </div>

        <div class="simulation-box" style="border-color:#F39800;">
            <h3 class="sim-title" style="color:#F39800;">âš™ï¸ ç³»çµ±åƒæ•¸é…ç½®</h3>
            <table>
                <thead>
                    <tr>
                        <th width="40">Lv</th>
                        <th>ç¨±è™Ÿ</th>
                        <th width="80">EXP é–€æª»</th>
                        <th>åœ–ç‰‡</th>
                    </tr>
                </thead>
                <tbody id="configTable">
                    </tbody>
            </table>
            <button class="btn btn-save" onclick="saveConfig()">ğŸ’¾ ä¿å­˜åƒæ•¸è¨­å®š</button>
        </div>

    </div>

    <div class="preview-panel">
        <div style="color:white; margin-bottom:10px; font-weight:bold;">ğŸ“± æ‰‹æ©Ÿç•«é¢é è¦½</div>
        <div class="phone-mockup">
            <iframe id="previewFrame" src="member.html"></iframe>
        </div>
    </div>

</div>

<script>
    // 1. åŸå» é è¨­å€¼
    const defaultConfig = [
        { lv: 1, name: "ç ´æ®¼è¦‹ç¿’ç”Ÿ", minExp: 0, img: "images/duck_lv1.png" },
        { lv: 2, name: "å¥½å¥‡æ¢éšªé´¨", minExp: 500, img: "images/duck_lv2.png" },
        { lv: 3, name: "å¥åº·å°å¹«æ‰‹", minExp: 3000, img: "images/duck_lv3.png" },
        { lv: 4, name: "åˆéšæŠ«è¢é´¨", minExp: 10000, img: "images/duck_lv4.png" },
        { lv: 5, name: "èª¿åŠ‘ç†Ÿæ‰‹é´¨", minExp: 25000, img: "images/duck_lv5.png" },
        { lv: 6, name: "è¡›æ•™é ˜èˆªå“¡", minExp: 50000, img: "images/duck_lv6.png" },
        { lv: 7, name: "è³‡æ·±è—¥å¸«é´¨", minExp: 100000, img: "images/duck_lv7.png" },
        { lv: 8, name: "å¤§æ¨¹åº—é•·é´¨", minExp: 250000, img: "images/duck_lv8.png" },
        { lv: 9, name: "æ¦®è­½é•·è€é´¨", minExp: 500000, img: "images/duck_lv9.png" },
        { lv: 10, name: "é†«è—¥å®ˆè­·ç¥", minExp: 1000000, img: "images/duck_lv10.png" }
    ];

    let currentConfig = [];

    function init() {
        const saved = localStorage.getItem('customLevelConfig');
        currentConfig = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(defaultConfig));
        renderTable();

        // è¼‰å…¥ User ç‹€æ…‹åŒæ­¥åˆ°æ‹‰æ¡¿
        const user = JSON.parse(localStorage.getItem('duckUser')) || { exp: 0, coins: 50 };
        updateSimUI(user.exp, user.coins);
    }

    function updateSimUI(exp, coins) {
        document.getElementById('simExpSlider').value = exp;
        document.getElementById('simExpInput').value = exp;
        document.getElementById('simCoinSlider').value = coins;
        document.getElementById('simCoinInput').value = coins;
    }

    function renderTable() {
        const tbody = document.getElementById('configTable');
        tbody.innerHTML = '';
        currentConfig.forEach((item, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="font-weight:bold; color:#F39800;">${item.lv}</td>
                <td><input type="text" value="${item.name}" onchange="updateItem(${index}, 'name', this.value)"></td>
                <td><input type="number" value="${item.minExp}" onchange="updateItem(${index}, 'minExp', this.value)"></td>
                <td style="display:flex; align-items:center; gap:5px;">
                    <input type="text" value="${item.img}" onchange="updateItem(${index}, 'img', this.value)" style="width:80px;">
                    <img src="${item.img}" class="preview-img" onerror="this.src='images/my_duck.png'">
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function updateItem(index, field, value) {
        if (field === 'minExp') value = parseInt(value);
        currentConfig[index][field] = value;
    }

    function saveConfig() {
        localStorage.setItem('customLevelConfig', JSON.stringify(currentConfig));
        alert("âœ… ç³»çµ±åƒæ•¸å·²ä¿å­˜ï¼");
        document.getElementById('previewFrame').contentWindow.location.reload();
    }

    function syncExpInput(val) { document.getElementById('simExpInput').value = val; }
    function syncExpSlider(val) { document.getElementById('simExpSlider').value = val; }
    function syncCoinInput(val) { document.getElementById('simCoinInput').value = val; }
    function syncCoinSlider(val) { document.getElementById('simCoinSlider').value = val; }

    // å¥—ç”¨æ¨¡æ“¬ (å¼·åˆ¶è¨ˆç®—ä¸¦è¦†è“‹ç‹€æ…‹)
  // === 6. å¥—ç”¨æ¨¡æ“¬ (é›™å‘åŒæ­¥ï¼šå‡ç´šè§£é– / é™ç´šä¸Šé–) ===
    // === 6. å¥—ç”¨æ¨¡æ“¬ (ä¿®æ­£ç‰ˆï¼šé™ç´šæ™‚æœƒè‡ªå‹•ä¸Šé–) ===
    function applySimulation() {
        const newExp = parseInt(document.getElementById('simExpInput').value);
        const newCoins = parseInt(document.getElementById('simCoinInput').value);

        // 1. æ‰¾å‡ºé€™å€‹ EXP å°æ‡‰çš„ç­‰ç´šè¨­å®š
        let sortedConfig = [...currentConfig].sort((a, b) => b.minExp - a.minExp);
        let targetLevelObj = sortedConfig.find(cfg => newExp >= cfg.minExp) || currentConfig[0];

        // 2. è®€å–ä½¿ç”¨è€…è³‡æ–™
        let user = JSON.parse(localStorage.getItem('duckUser')) || { 
            level: 1, currentSkin: "images/duck_lv1.png", unlockedSkins: ["images/duck_lv1.png"] 
        };

        // 3. â˜…â˜…â˜… æ ¸å¿ƒä¿®æ­£ï¼šé‡æ–°è¨ˆç®—æ“æœ‰çš„çš®è†š (å¤§æƒé™¤) â˜…â˜…â˜…
        
        // A. æ‰¾å‡ºæ‰€æœ‰ã€Œç­‰ç´šçå‹µã€çš„åœ–ç‰‡æ¸…å–® (ä¸ç®¡ç­‰ç´šå¤šå°‘ï¼Œåªè¦æ˜¯å‡ç´šé€çš„éƒ½ç®—)
        // é€™æ¨£æˆ‘å€‘æ‰èƒ½åˆ†è¾¨å“ªäº›æ˜¯ã€Œé€çš„ã€ï¼Œå“ªäº›æ˜¯ã€Œè²·çš„ã€
        const allLevelRewardSkins = currentConfig.map(cfg => cfg.img);

        // B. å…ˆæŠŠã€Œè²·ä¾†çš„è¡£æœã€æ•‘å‡ºä¾† (ä¸åœ¨ç­‰ç´šæ¸…å–®è£¡çš„ï¼Œå°±æ˜¯è²·çš„)
        let purchasedSkins = user.unlockedSkins.filter(skin => !allLevelRewardSkins.includes(skin));

        // C. æ ¹æ“šã€Œæ–°ç­‰ç´šã€ï¼Œé‡æ–°ç™¼æ”¾æ‡‰å¾—çš„ç­‰ç´šçš®è†š
        let validLevelSkins = [];
        currentConfig.forEach(cfg => {
            // åªæœ‰ç­‰ç´šé”æ¨™çš„ï¼Œæ‰å‡†æ”¾é€²å»
            if (targetLevelObj.lv >= cfg.lv) {
                validLevelSkins.push(cfg.img);
            }
        });

        // D. åˆä½µæ¸…å–® (è²·çš„ + æ–°ç­‰ç´šæ‡‰å¾—çš„) = æ–°çš„åˆæ³•æ¸…å–®
        user.unlockedSkins = [...new Set([...purchasedSkins, ...validLevelSkins])];

        // 4. æ›´æ–°ç‹€æ…‹
        user.exp = newExp;
        user.coins = newCoins;
        user.level = targetLevelObj.lv;

        // 5. æ›è£æª¢æŸ¥ (å¦‚æœèº«ä¸Šç©¿çš„è¢«æ²’æ”¶äº†ï¼Œå¼·åˆ¶æ›å› Lv.1)
        if (!user.unlockedSkins.includes(user.currentSkin)) {
            user.currentSkin = currentConfig[0].img;
        } 
        // ç‚ºäº†é è¦½æ–¹ä¾¿ï¼šå¦‚æœæ‹‰åˆ°é«˜ç­‰ç´šï¼Œå¼·åˆ¶æ›ä¸Šè©²ç­‰ç´šæœ€æ–°çš„è¡£æœ
        else if (allLevelRewardSkins.includes(user.currentSkin)) {
             user.currentSkin = targetLevelObj.img;
        }

        // 6. å­˜æª”ä¸¦åˆ·æ–°
        localStorage.setItem('duckUser', JSON.stringify(user));
        document.getElementById('previewFrame').contentWindow.location.reload();
    }

    // â˜…â˜…â˜… æ–°åŠŸèƒ½ï¼šæ¸…é™¤è³¼è²·ç´€éŒ„ (ä¿ç•™ç­‰ç´šçå‹µ) â˜…â˜…â˜…
    function clearShopPurchases() {
        if(!confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ã€Œå•†åŸè³¼è²·ã€çš„æ™‚è£å—ï¼Ÿ\n(ç­‰ç´šè§£é–çš„æ™‚è£æœƒä¿ç•™ï¼ŒéŒ¢å¹£ä¸æœƒè®Šå°‘)")) return;

        let user = JSON.parse(localStorage.getItem('duckUser')) || { level: 1 };
        
        // 1. æ‰¾å‡ºç©å®¶ç›®å‰ç­‰ç´šã€Œæ‡‰å¾—ã€çš„æ‰€æœ‰çå‹µ
        let legitimateSkins = [];
        currentConfig.forEach(cfg => {
            if (user.level >= cfg.lv) {
                legitimateSkins.push(cfg.img);
            }
        });

        // 2. è¦†è“‹è§£é–æ¸…å–® (åªä¿ç•™ç­‰ç´šçå‹µ)
        user.unlockedSkins = [...legitimateSkins];

        // 3. å¦‚æœç©å®¶èº«ä¸Šç©¿çš„æ˜¯å•†åŸè²¨(è¢«æ¸…æ‰äº†)ï¼Œå¼·åˆ¶è„«æ‰æ›å› Lv.1
        if (!legitimateSkins.includes(user.currentSkin)) {
            user.currentSkin = currentConfig[0].img; 
        }

        // 4. å­˜æª”ä¸¦åˆ·æ–°
        localStorage.setItem('duckUser', JSON.stringify(user));
        document.getElementById('previewFrame').contentWindow.location.reload();
        
        alert("å·²æ¸…é™¤è³¼è²·ç´€éŒ„ï¼è¡£æ«ƒå·²é‡ç½®ã€‚");
    }

    function resetToDefault() {
        if(confirm("ç¢ºå®šè¦æ¢å¾©åŸå» è¨­å®šå—ï¼Ÿ")) {
            localStorage.removeItem('customLevelConfig');
            init(); 
            document.getElementById('previewFrame').contentWindow.location.reload();
        }
    }

    init();
</script>

</body>
</html>
